# libsodium 初步

## 安装

[sodium](https://doc.libsodium.org/) 是一个现代的、易用的软件库，被用于加密，解密，签名和密码散列等用途。其被广泛应用于大量网络加密软件中，如 shadowsocks-libev 等。在 arch linux 上使用如下命令安装。

```bash
sudo pacman -S libsodium
```

如下代码用来初始化 sodium,进行随机化播种等动作。初始化后即可调用各个库函数。

[init](../src/libsodium/init.c ':include')

## 密码体制

当前有两种密码体制：一种称为对称密钥密码体制；另一种称为公钥密码体制。

在对称密钥密码体制中，加密和解密使用相同的密钥。密钥由通信双方事先约定。算法可以公开，而密钥需要保密。

公钥密码体制在加密和解密过程中使用不同的密钥。并且使用其中一个进行加密，则需要用另一个才能解密。这两个成对的密钥在使用时，一个密钥作为私钥，需要保密；另一个密钥作为公钥，可以公开。

## 对称加密算法

对称加密算法分为分组密码（又称块加密）和序列密码（又称流密码、流加密）两种。

- 著名的分组密码：DES、AES
- 常用的流密码：Salsa20、ChaCha20

## MAC 报文鉴别码

MAC 是 Message Authentication Code 的缩写，即报文鉴别码。通常是经过加密的散列值。计算报文鉴别码的算法称为 MAC 算法。常用的 MAC 算法有：

- GMAC
- CBC-MAC
- Poly1305

## AE

AE 是 Authenticated encryption 的缩写。顾名思义，这种加密方案不仅能提供机密性，还能提供完整性。任何伪造或篡改都会被发现。

AE 实际上是对称加密算法和 MAC 算法的结合体。在加密一个报文时，需要一个密钥和一个不重数(Nonce)，加密后将得到密文和一个报文鉴别码。报文鉴别码须随同密文一起发送给接收方。

接收方收到报文鉴别码和密文后，须用相同的密钥和不重数才能进行解密。任何对密文和报文鉴别码的篡改都会导致解密失败。当然，只要确保密钥没有泄露，其他人也无法伪造出合法的密文和相应的报文鉴别码。

不重数，即不重复的数，通常是从 0 开始递增的计数器，不需要保密。密钥和不重数的结合，相当于一次一密，能有效抵御「重放攻击」。

## AEAD

AEAD 是 Authenticated Encryption with Additional Data 的缩写。相比于 AE，AEAD 在加、解密时还可以选择性地给定一些没有保密性要求的「附加数据」，例如版本号、时间戳、报文的长度和编码方式等。这些附加数据会参与到报文鉴别码的计算中去，但不会被加密，也不会成为密文的一部分。附加数据可以随同密文一起发送。

常用的 AEAD 有以下两种：

- AES256-GCM
- ChaCha20-Poly1305

ChaCha20-Poly1305 最初在 2014 年提出，在 2015 年成为 IETF 标准，即 ChaCha20-Poly1305-IETF。后来，又通过对 ChaCha20 的改进，形成 XChaCha20-Poly1305-IETF。这一版本有望成为新的 IETF 标准，也是 Libsodium 目前首推的加密方案。

不同 AEAD 的密钥、不重数和报文鉴别码的长度（单位：bit）：

| AEAD                    | Key 密钥 | Nonce 不重数 | MAC 报文鉴别码 |
| ----------------------- | -------- | ------------ | -------------- |
| AES256-GCM              | 256      | 96           | 128            |
| ChaCha20-Poly1305       | 256      | 64           | 128            |
| ChaCha20-Poly1305-IETF  | 256      | 96           | 128            |
| XChaCha20-Poly1305-IETF | 256      | 192          | 128            |

---

ref: [[1]](https://doc.libsodium.org)[[2]](https://learnku.com/articles/54114)
