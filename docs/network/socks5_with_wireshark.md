# 通过 wireshark 抓包认识 socks5

本节将通过阅读[RFC1928](https://tools.ietf.org/pdf/rfc1928.pdf)，以及实战对 socks5 协议中 TCP 模式的抓包，来直观的认识 socks5 协议，为后续的内容打下基础。本节内容一定要动手实际操作，对照来看，否则你很难得到一个直观的理解。socks5 协议位于会话层，处于应用层与传输层之间，可以为 TCP 和 UDP 域提供代理服务。其所处的位置也意味着其不能为网络层的协议如 ICMP 提供服务。

对比与之前的 socks4 版本，socks5 新增了 UDP 支持，强认证功能，以及地址类型支持域名模式和 IPV6 模式。

> RFC 文档中表格里出现的十进制数字代表当前字段占用几个八位字节。`X‘hh’`的形式代表当前 8bit 单字节字段是一个指定值。`Variable`的形式代表当前字段是一个可变的长度，其长度根据其他一或两个单字节的字段值决定，或根据一个数据类型的字段值决定。

本节中，socks5 服务端使用[microsocks](https://archlinux.org/packages/community/x86_64/microsocks/),其默认启动在本地 1080 端口。客户端使用 curl 发起 socks 请求。

```bash
curl -v --socks5-hostname 127.0.0.1:1080 http://www.baidu.com
```

在 wireshark 中监听本地环回，并用`tcp.port == 1080`过滤请求。在使用 curl 发出请求后，即可在 wireshark 中看到抓取的全部包。

首先第一到第三个包为由 curl 客户端发起的，典型的 tcp 三次握手的过程。第四个包是客户端发出的 socks5 请求。可以在包数据的最后部分看到，05 代表协议为 socks5,02 为支持数目为两种认证模式，随后的 00 和 01 分别代表无认证和 GSSAPI 认证模式。

第五个包是服务端的 ACK 包。第六个包是服务端的响应，可以看到 05 依旧代表协议，00 为采用的认证方式，即无认证。如果 METHOD （方法）字段为 X’FF‘， 表示方法列表中的所有方法均不可用，客户端收到此信息必须关闭连接。

目前已存在定义方法如下：

- X’00'　　 无需认证
- X’01‘　　 GSSAPI
- X’02‘　　 用户名/密码
- X’03‘　到　 X’7F’　　 IANA 指定
- X’80‘　到　 X’FE’ 为私有方法保留
- X’FF‘ 无可接受方法

一个可称为具有兼容性的 socks5 实现必须支持 GSSAPI，并且应该支持用户名/密码身份验证方法。

一旦认证方法对应的协商完成，客户端就可以发送请求细节了。如果认证方法要求了完整性或者可信性的校验，要求对后续请求报文进行封装，则后续请求报文都要按照对应规定进行封装。

第七个包是客户端的 ACK 包。第八个包是客户端发给服务端的请求内容的包。可以在包的尾部看到，05 代表协议为 socks5，01 代表 CONNECT 建立链接，00 为保留字段，03 为地址类型，这里 03 代表是域名类型。随后的 14 个字节代表的内容是 www.baidu.com 这个域名的分字节十六进制的表示方式，注意，这部分的第一个字节代表的是域名的长度，这里可以看到 0d 代表长度为 13，随后的 13 字节转换为十进制后为域名字母对应的 ASCII 码。最后的两个字节代表所请求的端口号，这里为 80。

第九个包是服务端的 ACK 包。第十个包是服务端发给客户端的响应包。可以看到尾部第一字节为协议值 socks5,随后的 REP 字段值为 00,代表成功请求。接下来是保留字段 00 和地址类型为 ipv4。最后两个字段是服务端连接远程目标服务器所使用的地址和端口，这两个字段一般与客户端连接的 SOCKS 服务端地址和端口不同，因为此类服务往往是多台机器提供服务。这两个字段常填充为 0,实际上客户端其实并不需要用到它们，具体填充行为根据 socks5 服务端而定。如果协商的方法为了完整性、可信性的校验需要封装数据包，则返回的数据包也会进行对应的封装。

第十一个包是客户端的 ACK 包。随后就是 HTTP 的传输流程了。需要注意的是，最后 TCP 挥手的过程中，你可以看到是三步挥手。实际上三步挥手是完全合法的,即服务端同时一并传回 ACK 与 FIN。

Ref: [[1]](https://www.quarkay.com/code/383/socks5-protocol-rfc-chinese-traslation) [[2]](https://www.quarkay.com/code/394/SOCKS5-protocol-wireshark-capture-analysis) [[3]](https://www.muzaozong.com/%E7%BD%91%E7%BB%9C/%E7%94%A8c%E8%AF%AD%E8%A8%80%E5%86%99%E4%B8%80%E4%B8%AAsocks5%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/#4-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82)
